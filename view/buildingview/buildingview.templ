package buildingview

import (
	"github.com/mangustc/obd/view"
	"github.com/mangustc/obd/schema"
	"github.com/mangustc/obd/schema/buildingschema"
	"fmt"
)

const (
	pageTitle          = "Buildings"
	tableTitle         = pageTitle
	insertFormTitle    = tableTitle
	getPOSTURL         = "/api/building/getbuildings"
	insertPOSTURL      = "/api/building/insertbuilding"
	editPOSTURL        = "/api/building/editbuilding"
	updatePOSTURL      = "/api/building/updatebuilding"
	deletePOSTURL      = "/api/building/deletebuilding"
	buildingTN         = "Building"
	bodyVals           = `{"` + buildingTN + `ID": %d}`
	getbuildingPOSTURL = "/api/building"
)

var (
	taBuildingName     = schema.NewTA(buildingTN+"Name", "Name", schema.StringInput)
	taBuildingAddress  = schema.NewTA(buildingTN+"Address", "Address", schema.StringInput)
	taBuildingIsHidden = schema.NewTA(buildingTN+"IsHidden", "Is Hidden", schema.BooleanInput)
)

func getTableHeaders() []*schema.TableHeaderColumn {
	return []*schema.TableHeaderColumn{
		schema.NewTableHeaderColumn(taBuildingName.TATitle, 20),
		schema.NewTableHeaderColumn(taBuildingAddress.TATitle, 70),
		schema.NewTableHeaderColumn(taBuildingIsHidden.TATitle, 10),
	}
}

func getInsertFormInputs() []*schema.Input {
	return []*schema.Input{
		schema.NewInput(taBuildingName.TATitle, taBuildingName.TAName, taBuildingName.TAInputType, "", nil, nil, ""),
		schema.NewInput(taBuildingAddress.TATitle, taBuildingAddress.TAName, taBuildingAddress.TAInputType, "", nil, nil, ""),
	}
}

func getInputsFromBuildingDB(buildingDB *buildingschema.BuildingDB) []*schema.Input {
	return []*schema.Input{
		schema.NewInput("", taBuildingName.TAName, taBuildingName.TAInputType, buildingDB.BuildingName, nil, nil, ""),
		schema.NewInput("", taBuildingAddress.TAName, taBuildingAddress.TAInputType, buildingDB.BuildingAddress, nil, nil, ""),
		schema.NewInput("", taBuildingIsHidden.TAName, taBuildingIsHidden.TAInputType, buildingDB.BuildingIsHidden, nil, nil, ""),
	}
}

templ BuildingTableRowEdit(buildingDB *buildingschema.BuildingDB) {
	@view.TableRowEdit(getInputsFromBuildingDB(buildingDB), fmt.Sprintf(bodyVals, buildingDB.BuildingID), updatePOSTURL, deletePOSTURL)
}

templ BuildingTableRow(buildingDB *buildingschema.BuildingDB) {
	@view.TableRow(getInputsFromBuildingDB(buildingDB), fmt.Sprintf(bodyVals, buildingDB.BuildingID), editPOSTURL, deletePOSTURL)
}

templ BuildingTableRows(buildingsDB []*buildingschema.BuildingDB) {
	for _, buildingDB := range buildingsDB {
		@BuildingTableRow(buildingDB)
	}
}

templ Building() {
	@view.InsertForm(insertFormTitle, insertPOSTURL, getInsertFormInputs())
	@view.Table(tableTitle, getPOSTURL, getTableHeaders())
}

templ BuildingPage() {
	@view.Layout(pageTitle) {
		<div
			hx-post={ getbuildingPOSTURL }
			hx-target="this"
			hx-swap="outerHTML"
			hx-trigger="load"
		></div>
	}
}
